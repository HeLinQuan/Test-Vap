#include "define.h"
#include "AD_Temperature.h"

/**********全局变量*************/
unsigned char TEMP_HEAT,TEMP_COLD;

/**********局部变量*************/
unsigned char ERR_CODE1,ERR_CODE2;
volatile unsigned int  AD_SUM=0  , AD_DC1=0 ;
unsigned int  xdata TEMP_BUFF[10] ; 
unsigned char  ad_cnt = 0; 
unsigned char AD_CHN=1  , AD_CHANL; 
volatile unsigned char adc_i;

void ParamAdworkInit(void)
{
    TEMP_HEAT = 0;
    TEMP_COLD = 0;
    ERR_CODE1 = 0;
    ERR_CODE2 = 0;
}

/*******3950B 下拉 0~99度 温度值**********
const unsigned int code TEMP_AD[107]=
{
 // 230,
	240,250,259,269,279,289,300,310,321,331,//    ;9
	342,353,364,375,387,398,409,421,432,443,//19
	455,466,478,489,500,512,523,534,545,556,//29
	567,577,588,599,609,619,629,639,649,659,//39
	668,677,687,696,704,713,721,730,738,746,//49  
	753,761,768,776,783,790,796,803,809,815, //59
	821,827,833,838,843,848,853,858,863,869, //69	
	873,878,882,886,890,894,898,901,905,908, //79
	912,915,918,921,924,927,930,933,935,938, //89  	   	
	940,942,944,946,948,950,952,954,955,956, //99
	958,960,962,964,966,968,970,
//	873,878,881,884,887,890,893,896,899,902, //79
//	905,908,911,914,917,920,923,926,928,930, //89  	   	
//	932,934,936,938,940,942,944,946,948,950, //99
//	952,954,956,958,960,962,964,
};
***********************************************/

/*******3950B 下拉 0~99度 温度值***********/

//const unsigned int code TEMP_AD[108]=    //旧的温度点
//{ 
//	//240,250,259,269,279,289,300,310,321,331,//    ;9
////    250,259,269,279,289,300,310,321,331,//    ;9   
//	
//	240,251,262,273,284,295,306,317,328,339,//    ;10
//	350,360,370,380,390,400,410,420,430,440,//20
//	450,459,469,480,491,502,513,524,535,546,557,//31
//	567,577,588,599,609,619,629,639,649,659,//41
//	668,677,686,695,704,713,722,730,738,746,//51  
//	753,760,767,774,781,788,795,801,807,813, //61
//	819,825,831,837,842,847,851,856,861,866, //71
//	871,875,879,883,887,891,895,899,903,906, //81
//	909,912,914,916,918,920,922,924,926,929, //91    新温度点		   	
//	932,935,938,941,944,946,948,950,952,953,954,955,956,957,958,

//};

/*******3950B 下拉 0~99度 温度值**********/
/*const unsigned int code  TEMP_AD[108]=
{ 

	230,240,250,259,269,279,289,300,310,321,331,//    ;10	
	342,353,364,375,387,398,409,421,432,443,//19
	455,466,478,489,500,512,523,534,545,556,//29
	567,577,588,599,609,619,629,639,649,659,//39
	668,677,686,695,704,713,722,730,738,746,//49  
	753,760,767,774,781,788,795,801,807,813, //59
	819,824,828,832,836,840,844,848,852,856, //69
	860,864,868,872,876,880,884,888,892,896, //79
	900,904,908,912,916,920,924,928,932,936, //89 90   新温度点		   	
  940,944,948,951,954,957,960,963,965,966,967,968,969,970	
	
//937,940,944,948,952,956,958,960,962,964,965,966,967,968,  //231010
};*/

/*******3950B 下拉 0~99度 温度值**********/
/*const unsigned int code  TEMP_AD[108]=
{ 

	230,240,250,259,269,279,289,300,310,321,331,//    ;10	
	342,353,364,375,387,398,409,421,432,443,//20
	455,466,478,489,500,512,523,534,545,556,//30
	567,577,588,599,609,619,629,639,649,659,//40
	668,677,686,695,704,713,722,730,738,746,//50  
	753,760,767,774,781,788,795,801,807,813, //60
	819,824,828,832,836,840,844,848,852,856, //70
	860,864,868,872,876,880,884,888,892,896, //80
	900,904,908,912,916,920,924,928,932,934, //90   新温度点		   	
    936,938,940,942,944,946,948,950,953,955,957,959,961,963	
	
//937,940,944,948,952,956,958,960,962,964,965,966,967,968,  //231010
};*/

const unsigned int code TEMP_AD[106] = 
{
	/*788 ,*/784 ,776 ,764 ,756 ,748 ,736 ,728 ,716 ,708 ,696 , 
	684 ,672 ,664 ,652 ,640 ,628 ,616 ,604 ,592 ,580 , 
	568 ,556 ,548 ,536 ,524 ,512 ,500 ,488 ,480 ,468 ,
	460 ,448 ,436 ,428 ,416 ,404 ,396 ,384 ,376 ,364 , 
	356 ,344 ,336 ,328 ,316 ,308 ,300 ,292 ,284 ,280 ,
	272 ,264 ,256 ,248 ,240 ,236 ,228 ,220 ,216 ,208 ,
	204 ,196 ,192 ,184 ,180 ,176 ,168 ,164 ,160 ,156 , 
	148 ,145 ,142 ,140, 137 ,135 ,133 ,130 ,128 ,126 ,
	124 ,122 ,120 ,118 ,116 ,114 ,112 ,110 ,108 ,106 ,
    104,102 ,100 ,98  ,96  ,94  ,92  ,90 , 88  , 86 ,
	84  ,82  ,80  ,78  ,76  ,74  //,72  ,70  ,68 , 66 , 64 , 63 , 62 ,60
};



void AD_TEMP(void)
{
	  unsigned char  j , i 	; 
      
	  volatile unsigned int temp_wd; 
	  volatile unsigned int xdata temp_ttt  , TEMP_LINSHI; 
      
	
	  if(AD_CHN==0)
      {
            AD_CHANL = 0x17;   //AN23 冷水
      }          
	  else if(AD_CHN==1)
      {
            AD_CHANL = 0x19;  //AN25 热水
      }          
    
	  for(i=0 ;i<10 ;i++)
	  {	   
				ADCC1 = AD_CHANL	;		     //选择外部通道23 or 25
                delay_us(20);
				ADCC0 |= 0x40;				   //启动ADC转换
				while(!(ADCC0&0x20));		  //等待ADC转换结束
				ADCC0 &=~ 0x20;				 //清除标志位	
				AD_SUM+= ADCR;			    //获取ADC的值	
      }
      
	  AD_DC1 = AD_SUM/10 ; 
      
	  AD_SUM = 0 ; 	
      
	  TEMP_BUFF[ad_cnt]	 = AD_DC1 ;
      
		if(++ad_cnt>=10)
		{
				ad_cnt = 0 ;	
				for(j=0 ;j<9 ; j++)    
				{
						for(i= 0 ; i<(9-j) ; i++)
						{
								if(TEMP_BUFF[i]>TEMP_BUFF[i+1])
								{
										temp_wd = TEMP_BUFF[i] ; 
										TEMP_BUFF[i]=TEMP_BUFF[i+1] ;
										TEMP_BUFF[i+1] = temp_wd  ;
								}
						}
				}   
				for(i=2 ; i<10 ; i++)
				{
						temp_ttt+= TEMP_BUFF[i] ;
				}
                
                for(i=0 ; i<10 ; i++)
				{
						TEMP_BUFF[i] = 0;
				}
                
                
				TEMP_LINSHI= temp_ttt/32 ;   //  /8   and   /4  右移2位  12位AD  缩小了 4096-》1024
                
				temp_ttt = 0 ;
				for(adc_i=0 ;adc_i<105;adc_i++)
				{
							if(TEMP_LINSHI>TEMP_AD[adc_i]) break ;    //上拉是大于， 下拉要改为小于
				}	
				
				if(AD_CHN==0)   //AN23   冷水
				{
					  if(TEMP_LINSHI<40) ERR_CODE1 = 1 ; 
					  else if(TEMP_LINSHI>900)ERR_CODE1 = 2 ; 
					  else 
						{
							 if((ERR_CODE1==1)||(ERR_CODE1==2))
							 {
								   ERR_CODE1 = 0 ; 
							 }
						}
				}			
				else if(AD_CHN==1)   //AN25   热水
				{
					  if(TEMP_LINSHI<40) ERR_CODE2 = 3 ; 
					  else if(TEMP_LINSHI>900)ERR_CODE2 = 4 ;  
					  else 
						{
							 if((ERR_CODE2==3)||(ERR_CODE2==4))
							 {
								   ERR_CODE2 = 0 ; 
							 }
						}
				}
                TEMP_LINSHI = 0 ;
                
                if(AD_CHN == 0)
                {
                    TEMP_COLD = adc_i;
                }
                else
                {
                    TEMP_HEAT = adc_i;
                }
                
                if(AD_CHN == 0)
                {
                    AD_CHN = 1;
                }
                else
                {
                    AD_CHN = 0;
                }
                    
		} 
}		  


